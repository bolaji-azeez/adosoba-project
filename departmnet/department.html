<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title id="pageTitle">Department • GTC Adosoba</title>
    <link rel="stylesheet" href="./department.css" />
  </head>
  <body>
    <header>
      <nav>
        <img src="/student/image.png" alt="" height="64" />
        <h1>GTC Adosoba</h1>
      </nav>
      <div class="user-actions">
        <span>Admin User</span>
        <button onclick="logout()" class="logout">LOGOUT</button>
      </div>
    </header>

    <div class="container">
      <main>
        <nav class="breadcrumb">
          <h3 style="margin: 0">Dashboard &gt;</h3>
          <span id="breadcrumbDept">Department</span>
        </nav>
        <section class="department">
          <div class="oegene">
            <div>
              <h2 id="deptName">Department</h2>
              <p id="deptDesc">Department details</p>
            </div>
            <button onclick="AddStudent()" class="add-student">
              + ADD STUDENT
            </button>
          </div>

          <!-- SORT & FILTER TOOLBAR -->
          <div class="table-controls" aria-label="Table controls">
            <div class="control-group search" title="Search by name or ID">
              <label for="searchInput">Search</label>
              <input
                id="searchInput"
                type="search"
                placeholder="Type a name or ID…" />
            </div>
            <div class="control-group" title="Filter by status">
              <label for="statusFilter">Status</label>
              <select id="statusFilter">
                <option value="all">All</option>
                <option>Active</option>
                <option>Suspended</option>
                <option>Probation</option>
                <option>Graduated</option>
                <option>Withdrawn</option>
              </select>
            </div>
            <div class="control-group" title="Sort field">
              <label for="sortBy">Sort by</label>
              <select id="sortBy">
                <option value="name">Name</option>
                <option value="date">Enrollment Date</option>
                <option value="status">Status</option>
              </select>
            </div>
            <!-- Replaced Order with Date filter -->
            <div class="control-group" title="Filter by enrollment date">
              <label for="dateFilter">Date</label>
              <input id="dateFilter" type="date" />
            </div>
          </div>

          <div class="table-wrap" role="region" aria-label="Students table">
            <table>
              <thead>
                <tr>
                  <th>STUDENT ID</th>
                  <th>NAME</th>
                  <th>EMAIL</th>
                  <th>PROJECTS</th>
                  <th>STATUS</th>
                  <th>ACTIONS</th>
                </tr>
              </thead>
              <tbody id="studentsTableBody"></tbody>
            </table>
          </div>
          <div class="pagination" id="pagination"></div>
        </section>
      </main>

      <!-- Profile Modal -->
      <div
        id="studentModalBackdrop"
        class="modal-backdrop"
        role="dialog"
        aria-modal="true"
        aria-hidden="true">
        <div class="modal" aria-labelledby="studentModalTitle">
          <header>
            <h3 id="studentModalTitle" style="margin: 0">Student Profile</h3>
            <button class="btn" onclick="closeStudentModal()">Close</button>
          </header>
          <div class="content" id="studentModalContent">
            <!-- Filled dynamically -->
          </div>
          <footer>
            <button class="btn" onclick="closeStudentModal()">Close</button>
          </footer>
        </div>
      </div>

      <div id="toast" class="toast" role="status" aria-live="polite"></div>
    </div>

    <script src="department.js">
      const urlParams = new URLSearchParams(window.location.search);
      const departmentId = urlParams.get("id");

      const API_BASE = "https://gtc-adosoba-be.onrender.com/api";
      const studentsCache = new Map();
      let studentsData = []; // master list for sorting/filtering

      const state = { sortBy:'name', status:'all', q:'', date:'', page:1, pageSize:50 };

      function setDepartmentInfo(dept) {
        const name = dept?.departmentName || "Department";
        document.getElementById("deptName").textContent = name;
        document.getElementById("breadcrumbDept").textContent = name;
        document.getElementById("deptDesc").textContent = dept?.description || `Department of ${name}`;
        document.getElementById("pageTitle").textContent = `${name} • GTC Adosoba`;
      }

      async function tryFetchDepartment() {
        try {
          const r = await fetch(`${API_BASE}/department/${departmentId}`);
          if (!r.ok) return; const d = await r.json();
          if (d?.department) setDepartmentInfo(d.department);
        } catch {}
      }

      function showToast(msg) {
        const t = document.getElementById("toast");
        t.textContent = msg; t.classList.add("show");
        setTimeout(() => t.classList.remove("show"), 2600);
      }

      function statusOptions(current) {
        const options = ["Active","Suspended","Probation","Graduated","Withdrawn"];
        return options.map(opt => `<option value="${opt}" ${String(current).toLowerCase()===opt.toLowerCase()?"selected":""}>${opt}</option>`).join("");
      }

      function projectStatusPill(status) {
        const s = String(status || "").toLowerCase();
        let color = "#e5e7eb", fg = "#111827";
        if (["completed"].includes(s)) { color = "#dcfce7"; fg = "#065f46"; }
        else if (["in progress","ongoing"].includes(s)) { color = "#dbeafe"; fg = "#1e40af"; }
        else if (["on hold","uncompleted"].includes(s)) { color = "#fef3c7"; fg = "#92400e"; }
        else if (["terminated","cancelled","canceled"].includes(s)) { color = "#fee2e2"; fg = "#991b1b"; }
        return `<span style="background:${color};color:${fg};padding:3px 8px;border-radius:999px;font-size:12px">${status || "—"}</span>`;
      }

      function byName(a,b){
        const an = `${a.firstName||''} ${a.lastName||''}`.trim().toLowerCase();
        const bn = `${b.firstName||''} ${b.lastName||''}`.trim().toLowerCase();
        if(an<bn) return -1; if(an>bn) return 1; return 0;
      }
      function byDate(a,b){
        const ad = a.enrollmentDate ? new Date(a.enrollmentDate).getTime() : 0;
        const bd = b.enrollmentDate ? new Date(b.enrollmentDate).getTime() : 0;
        return ad - bd; // ascending only
      }
      function byStatus(a,b){
        const as = (a.status||'').toLowerCase();
        const bs = (b.status||'').toLowerCase();
        if(as<bs) return -1; if(as>bs) return 1; return 0;
      }

      function ymd(d){
        const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,'0'); const da=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${da}`;
      }

      function renderPagination(total){
        const pag = document.getElementById('pagination');
        const totalPages = Math.ceil(total / state.pageSize) || 1;
        if(totalPages <= 1){ pag.innerHTML = ''; return; }
        const cur = Math.min(state.page, totalPages);
        let html = `<button class="page-btn" ${cur===1?'disabled':''} data-act="prev">Prev</button>`;
        // show up to 7 page numbers (windowed)
        const windowSize = 7;
        let start = Math.max(1, cur - Math.floor(windowSize/2));
        let end = Math.min(totalPages, start + windowSize - 1);
        start = Math.max(1, end - windowSize + 1);
        if(start > 1){ html += `<button class="page-num" data-pg="1">1</button>`; if(start>2) html += `<span>…</span>`; }
        for(let p=start; p<=end; p++){
          html += `<button class="page-num ${p===cur?'active':''}" data-pg="${p}">${p}</button>`;
        }
        if(end < totalPages){ if(end<totalPages-1) html += `<span>…</span>`; html += `<button class="page-num" data-pg="${totalPages}">${totalPages}</button>`; }
        html += `<button class="page-btn" ${cur===totalPages?'disabled':''} data-act="next">Next</button>`;
        pag.innerHTML = html;
      }

      function renderTable(){
        const tbody = document.getElementById("studentsTableBody");
        tbody.innerHTML = "";
        const q = state.q.trim().toLowerCase();
        let list = studentsData.slice();
        // Filter by status
        if(state.status !== 'all'){
          list = list.filter(s => String(s.status||'').toLowerCase() === state.status.toLowerCase());
        }
        // Filter by search
        if(q){
          list = list.filter(s => `${s.firstName||''} ${s.lastName||''}`.toLowerCase().includes(q) || (s.studentId||s.matricNo||'').toLowerCase().includes(q));
        }
        // Filter by date (exact match)
        if(state.date){
          list = list.filter(s => {
            if(!s.enrollmentDate) return false;
            const d = new Date(s.enrollmentDate); if(isNaN(d)) return false; return ymd(d) === state.date;
          });
        }
        // Sort
        let cmp = byName; if(state.sortBy==='date') cmp = byDate; else if(state.sortBy==='status') cmp = byStatus; list.sort(cmp);

        // Pagination
        const total = list.length;
        renderPagination(total);
        const totalPages = Math.ceil(total / state.pageSize) || 1;
        if(state.page > totalPages) state.page = 1;
        const start = (state.page - 1) * state.pageSize;
        const end = start + state.pageSize;
        const pageItems = list.slice(start, end);

        // Rows
        pageItems.forEach(stu => {
          const id = stu._id || stu.id || "";
          studentsCache.set(id, stu);
          const fullName = `${stu.firstName || ''} ${stu.lastName || ''}`.trim();
          const email = stu.email || stu.user?.email || '—';
          const projectsCount = Array.isArray(stu.projects) ? stu.projects.length : (stu.project ? 1 : 0);
          const status = stu.status || 'Active';
          const studentId = stu.studentId || stu.matricNo || id.slice(-8);

          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${studentId}</td>
            <td>${fullName || 'Unnamed'}</td>
            <td>${email}</td>
            <td>${projectsCount}</td>
            <td>
              <select class="status-select" id="status-${id}">${statusOptions(status)}</select>
            </td>
            <td class="actions">
              <button class="btn" onclick="openStudentModal('${id}')">View</button>
              <button class="btn primary" id="save-${id}" onclick="saveStatus('${id}')">Save</button>
            </td>`;
          tbody.appendChild(tr);
        });
      }

      async function fetchStudents() {
        try {
          const res = await fetch(`${API_BASE}/student/department/${departmentId}`);
          const data = await res.json();

          if (!res.ok) {
            document.getElementById("studentsTableBody").innerHTML = `<tr><td colspan="6">${data.message || 'Unable to load students.'}</td></tr>`;
            return;
          }
          if (data.student && data.student.length > 0) {
            const dept = data.student[0].department; if (dept) setDepartmentInfo(dept);
          }
          studentsData = Array.isArray(data.student) ? data.student : [];
          renderTable();
        } catch (err) {
          console.error("Error fetching students:", err);
          document.getElementById("studentsTableBody").innerHTML = `<tr><td colspan="6">Network error. Please try again.</td></tr>`;
        }
      }

      function openStudentModal(id) {
        const stu = studentsCache.get(id);
        if (!stu) return;
        const name = `${stu.firstName || ''} ${stu.lastName || ''}`.trim();
        const dept = stu.department?.departmentName || 'N/A';
        const email = stu.email || stu.user?.email || '—';
        const phone = stu.phone || '—';
        const enrollmentDate = (stu.enrollmentDate ? new Date(stu.enrollmentDate).toLocaleDateString() : '—');
        const status = document.getElementById(`status-${id}`)?.value || stu.status || 'Active';
        const studentId = stu.studentId || stu.matricNo || (stu._id || '').slice(-8);
        const initials = (name || 'ST').split(' ').map(s=>s[0]).join('').slice(0,2).toUpperCase();
        const projects = Array.isArray(stu.projects) ? stu.projects : (stu.project ? [stu.project] : []);
        const projectRows = projects.length ? projects.map((p, idx)=>{
          const title = p.title || p.projectTitle || `Project ${idx+1}`;
          const pstatus = p.status || p.projectStatus || 'In Progress';
          const grade = p.grade || p.score || '—';
          const desc = p.description || p.details || '';
          return `<tr>
              <td>${idx+1}</td>
              <td>${title}</td>
              <td>${projectStatusPill(pstatus)}</td>
              <td>${grade}</td>
              <td>${desc ? desc : '—'}</td>
            </tr>`;
        }).join("") : `<tr><td colspan="5">No Project Assigned</td></tr>`;

        const html = `
          <div class="profile">
            <div class="avatar">${initials}</div>
            <div>
              <h2 style="margin:0 0 6px 0">${name || 'Student'}</h2>
              <span class="badge">${dept}</span>
              <div class="kv">
                <div class="k">Student ID</div><div>${studentId}</div>
                <div class="k">Email</div><div>${email}</div>
                <div class="k">Phone</div><div>${phone}</div>
                <div class="k">Enrollment Date</div><div>${enrollmentDate}</div>
                <div class="k">Status</div><div><select class="status-select" id="modal-status-${id}">${statusOptions(status)}</select></div>
              </div>

              <h4 class="section-title">Projects (${projects.length})</h4>
              <div class="proj-table">
                <table>
                  <thead>
                    <tr>
                      <th>#</th>
                      <th>Title</th>
                      <th>Status</th>
                      <th>Grade</th>
                      <th>Description</th>
                    </tr>
                  </thead>
                  <tbody>${projectRows}</tbody>
                </table>
              </div>
            </div>
          </div>`;

        const content = document.getElementById("studentModalContent");
        content.innerHTML = html;
        const backdrop = document.getElementById("studentModalBackdrop");
        backdrop.style.display = "flex"; backdrop.setAttribute("aria-hidden","false");

        const modalSelect = document.getElementById(`modal-status-${id}`);
        modalSelect.addEventListener("change", () => {
          const tableSelect = document.getElementById(`status-${id}`);
          if (tableSelect) tableSelect.value = modalSelect.value;
        });
      }

      function closeStudentModal() {
        const backdrop = document.getElementById("studentModalBackdrop");
        backdrop.style.display = "none"; backdrop.setAttribute("aria-hidden","true");
      }

      async function saveStatus(id) {
        try {
          const btn = document.getElementById(`save-${id}`);
          const select = document.getElementById(`status-${id}`);
          if (!select) return; const newStatus = select.value;

          btn.disabled = true; btn.textContent = 'Saving…';
          const res = await fetch(`${API_BASE}/student/${id}`, {
            method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ status: newStatus })
          });
          const data = await res.json().catch(() => ({}));

          if (!res.ok) {
            showToast(data.message || 'Failed to update status');
            btn.disabled = false; btn.textContent = 'Save'; return;
          }
          const stu = studentsCache.get(id) || {}; stu.status = newStatus; studentsCache.set(id, stu);
          showToast('Status updated'); btn.textContent = 'Saved';
          setTimeout(()=>{ btn.disabled=false; btn.textContent='Save'; }, 1200);
          renderTable();
        } catch (e) {
          console.error(e);
          showToast('Network error while updating');
          const btn = document.getElementById(`save-${id}`); if(btn){ btn.disabled=false; btn.textContent='Save'; }
        }
      }

      function AddStudent() {
        window.location.href = `../../student/studentform.html?dept=${encodeURIComponent(departmentId)}`;
      }

      function logout() { alert('Logging out…'); }

      // Toolbar events
      document.addEventListener('input', (e)=>{
        if(e.target.id==='searchInput'){ state.q = e.target.value; state.page=1; renderTable(); }
      });
      document.addEventListener('change', (e)=>{
        if(e.target.id==='statusFilter'){ state.status = e.target.value; state.page=1; renderTable(); }
        if(e.target.id==='sortBy'){ state.sortBy = e.target.value; state.page=1; renderTable(); }
        if(e.target.id==='dateFilter'){ state.date = e.target.value; state.page=1; renderTable(); }
      });

      // Pagination events
      document.getElementById('pagination').addEventListener('click', (e)=>{
        const btn = e.target.closest('button'); if(!btn) return;
        const act = btn.getAttribute('data-act');
        if(act==='prev'){ state.page = Math.max(1, state.page-1); renderTable(); return; }
        if(act==='next'){
          const total = (studentsData||[]).length; // will be recalculated in renderTable via filters
          state.page = state.page + 1; renderTable(); return;
        }
        const pg = btn.getAttribute('data-pg');
        if(pg){ state.page = parseInt(pg,10)||1; renderTable(); }
      });

      // Initial load
      tryFetchDepartment();
      fetchStudents();

      // Close modal on backdrop click & ESC
      document.getElementById('studentModalBackdrop').addEventListener('click', (e)=>{ if(e.target.id === 'studentModalBackdrop'){ closeStudentModal(); } });
      document.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ closeStudentModal(); } });
    </script>
  </body>
</html>
