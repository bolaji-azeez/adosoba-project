<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Student Data Management</title>
    <link rel="stylesheet" href="dashboard.css" />
  </head>
  <body>
    <header>
      <h1>Student Data Management</h1>
      <div class="user-info">
        <span>Admin User</span>
        <button onclick="logout()">Logout</button>
      </div>
    </header>

    <div class="dashboard">
      <main>
        <section class="overview">
          <h2>Overview</h2>
          <div class="cards">
            <div class="card">
              <div class="icon"><img src="../add.jpg" alt="student" /></div>
              <p class="number" id="total-students">0</p>
              <p>Total Students</p>
            </div>
            <div class="card">
              <div class="icon"><img src="../add.jpg" alt="home" /></div>
              <p class="number" id="total-departments">0</p>
              <p>Total Departments</p>
            </div>
            <div class="card">
              <div class="icon"><img src="../add.jpg" alt="project" /></div>
              <p class="number" id="total-projects">0</p>
              <p>Total Projects</p>
            </div>
          </div>
        </section>

        <section class="departments">
          <div class="btn-h2">
            <h2>Departments</h2>

            <button class="btn-create" onclick="Create()">
              + Create Department
            </button>
          </div>

          <div class="dept-list"></div>
        </section>
      </main>
    </div>

    <script>
      const BASE = "https://gtc-adosoba-be.onrender.com/api";

      const len = (v) =>
        Array.isArray(v) ? v.length : typeof v === "number" ? v : 0;

      async function loadCountsAndDepartments() {
        try {
          const [studentsRes, deptRes] = await Promise.all([
            fetch(`${BASE}/student/all-student`),
            fetch(`${BASE}/department/all-departments`),
          ]);

          const [studentsJson, deptsJson] = await Promise.all([
            studentsRes.json(),
            deptRes.json(),
          ]);

          if (!studentsRes.ok)
            throw new Error(studentsJson?.message || "Failed to load students");
          if (!deptRes.ok)
            throw new Error(deptsJson?.message || "Failed to load departments");

          const allStudents = Array.isArray(studentsJson?.allStudents)
            ? studentsJson.allStudents
            : Array.isArray(studentsJson)
            ? studentsJson
            : [];
          const departments = Array.isArray(deptsJson?.departments)
            ? deptsJson.departments
            : Array.isArray(deptsJson)
            ? deptsJson
            : [];

          const totalStudents = allStudents.length;

          const studentCountByDept = {};
          for (const s of allStudents) {
            const deptId =
              s.departmentId ||
              (typeof s.department === "string"
                ? s.department
                : s.department?._id) ||
              s.deptId ||
              s.dept?._id ||
              null;

            if (deptId) {
              studentCountByDept[deptId] =
                (studentCountByDept[deptId] || 0) + 1;
            }
          }

          const totalDepartments = departments.length;

          let totalProjects = 0;

          const deptList = document.querySelector(".dept-list");
          deptList.innerHTML = "";

          for (const dept of departments) {
            const projectCountFromField = Number.isFinite(dept.projectCount)
              ? dept.projectCount
              : null;
            const studentCountFromField = Number.isFinite(dept.studentCount)
              ? dept.studentCount
              : null;

            const studentsInDept =
              studentCountFromField ??
              (dept.students
                ? len(dept.students)
                : studentCountByDept[dept._id] || 0);

            const projectsInDept =
              projectCountFromField ?? (dept.projects ? len(dept.projects) : 0);

            totalProjects += projectsInDept;

            const card = document.createElement("div");
            card.className = "dept-card";
            card.innerHTML = `
          <h3>${dept.departmentName || "Unnamed Department"}</h3>
          <p>${dept.description || "No description available"}</p>
          <p>
            <img src="../add.jpg" alt=""> ${studentsInDept} Students |
            <img src="../add.jpg" alt=""> ${projectsInDept} Projects
          </p>
        `;

            card.addEventListener("click", () => {
              window.location.href =
                "../../departmnet/department.html?id=" +
                encodeURIComponent(dept._id);
            });

            deptList.appendChild(card);
          }

          document.getElementById("total-students").textContent =
            String(totalStudents);
          document.getElementById("total-departments").textContent =
            String(totalDepartments);
          document.getElementById("total-projects").textContent =
            String(totalProjects);
        } catch (err) {
          console.error("Error loading dashboard:", err);
        }
      }

      function Create() {
        window.location.href = "../../departmnet/departmentForm.html";
      }

      function logout() {
        window.location.href = "../login/login.html";
      }

      window.Create = Create;
      window.logout = logout;

      window.onload = () => {
        loadCountsAndDepartments();
      };
    </script>
  </body>
</html>
